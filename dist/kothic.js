/*
 Copyright (c) 2011, Darafei Praliaskouski, Vladimir Agafonkin, Maksim Gurtovenko
 Kothic JS is a full-featured JavaScript map rendering engine using HTML5 Canvas.
 See http://github.com/kothic/kothic-js for more information.
*/
var Kothic={};
Kothic.render=function(){function a(i,a){return parseFloat(i.style["z-index"]||0)-parseFloat(a.style["z-index"]||0)}function d(i,u,b,g,t){var e=b.features,b=[],j,o,l,k,m,s;j=0;for(l=e.length;j<l;j++){m=k=e[j];s=g;var n=t,f=0;if(n)f=n.kothicId=n.kothicId||++r;var c=void 0,h=void 0,f=[MapCSS.currentStyle,f,JSON.stringify(m.properties),s,m.type].join(":");if(!q[f]){if(m.type=="Polygon"||m.type=="MultiPolygon")c="way",h="area";else if(m.type=="LineString"||m.type=="MultiLineString")c="way",h="line";else if(m.type==
"Point"||m.type=="MultiPoint")h=c="node";q[f]=MapCSS.restyle(m.properties,s,c,h);n&&n(q[f],m.properties,s,c,h)}m=q[f];for(o in m)if(m.hasOwnProperty(o)){s={};n=k;c=void 0;for(c in n)n.hasOwnProperty(c)&&(s[c]=n[c]);s.kothicId=j+1;s.style=m[o];b.push(s)}}b.sort(a);g=0;for(t=b.length;g<t;g++)o=b[g],e=parseFloat(o.properties.layer)||0,j=o.style["-x-mapnik-layer"],j=="top"&&(e=1E4),j=="bottom"&&(e=-1E4),e in i||(i[e]=[],u.push(e)),i[e].push(o);u.sort()}function e(i,a){for(var b in a)a.hasOwnProperty(b)&&
a[b]&&(i[b]=a[b])}function h(i,a,b){var g=a["fill-opacity"]||a.opacity;i.save();"fill-color"in a&&(e(i,{fillStyle:a["fill-color"],globalAlpha:g}),b());"fill-image"in a&&((a=MapCSS.getImage(a["fill-image"]))&&e(i,{fillStyle:i.createPattern(a,"repeat"),globalAlpha:g}),b());i.restore()}function m(i,a,b,g){g=MapCSS.restyle({},g,"canvas","canvas")["default"];i.save();h(i,g,function(){i.fillRect(-1,-1,a+1,b+1)});i.restore()}function c(i,a,b,g,q,e){var j=a.style,m=b&&b.style;n||(n=!0,i.beginPath());Kothic.path(i,
a,!1,!0,g,q,e);if(!b||!(m["fill-color"]===j["fill-color"]&&m["fill-image"]===j["fill-image"]&&m["fill-opacity"]===j["fill-opacity"]))i.save(),h(i,j,function(){i.fill()}),i.restore(),n=!1}function t(i,a,b){this.buffer=[];this.ctx=i;this.debugBoxes=a;this.debugChecks=b}function b(i,a,b,g,q,m,j,t){var l=a.style,k;a:switch(a.type){case "Point":k=a.coordinates;break;case "Polygon":k=a.reprpoint;break;case "LineString":k=a.coordinates[0];break;case "GeometryCollection":case "MultiPoint":case "MultiPolygon":case "MultiLineString":k=
void 0;break a}if(k){k=[g*k[0],q*(m-k[1])];var n;if(t){n=MapCSS.getImage(l["icon-image"]);if(!n)return;if(l["allow-overlap"]!="true"&&b.checkPointWH(k,n.width,n.height,a.kothicId))return}if(j){i.save();var j=l["text-halo-radius"]+2,c;c=l["font-family"];var f=l["font-size"];c=c||"";var f=f||9,h=c?c+", ":"";c=c.toLowerCase();var d=[];(c.indexOf("italic")!=-1||c.indexOf("oblique")!=-1)&&d.push("italic");c.indexOf("bold")!=-1&&d.push("bold");d.push(f+"px");h+=c.indexOf("serif")!=-1?"Georgia, serif":"Arial, Helvetica, sans-serif";
d.push(h);c=d.join(" ");e(i,{lineWidth:j,font:c});j=l.text+"";f=i.measureText(j).width;h=f/j.length*2.5;d=l["text-offset"]||0;if(l["text-allow-overlap"]!="true"&&b.checkPointWH([k[0],k[1]+d],f,h,a.kothicId)){i.restore();return}var r=l["text-opacity"]||l.opacity||1,G=l["text-color"]||"#000000",H=l["text-halo-color"]||"#ffffff";c="text-halo-radius"in l;r<1&&(G=(new RGBColor(G,r)).toRGBA(),H=(new RGBColor(H,r)).toRGBA());e(i,{fillStyle:G,strokeStyle:H,textAlign:"center",textBaseline:"middle"});if(a.type==
"Polygon"||a.type=="Point")c&&i.strokeText(j,k[0],k[1]+d),i.fillText(j,k[0],k[1]+d),g=parseFloat(l["-x-mapnik-min-distance"])||20,b.addPointWH([k[0],k[1]+d],f,h,g,a.kothicId);else if(a.type=="LineString"){f=a.coordinates;h=[];d=0;for(r=f.length;d<r;d++)h.push([g*f[d][0],q*(m-f[d][1])]);Kothic.textOnPath(i,h,j,c,b)}i.restore()}t&&(i.drawImage(n,Math.floor(k[0]-n.width/2),Math.floor(k[1]-n.height/2)),g=parseFloat(l["-x-mapnik-min-distance"])||0,b.addPointWH(k,n.width,n.height,g,a.kothicId))}}var q=
{},n=!1,r=0,f={strokeStyle:"rgba(0,0,0,0.5)",fillStyle:"rgba(0,0,0,0.5)",lineWidth:1,lineCap:"round",lineJoin:"round"};t.prototype={addBox:function(a){this.buffer.push(a)},addPointWH:function(a,b,c,g,q){a=this.getBoxFromPoint(a,b,c,g,q);this.buffer.push(a);if(this.debugBoxes)this.ctx.save(),this.ctx.strokeStyle="red",this.ctx.lineWidth="1",this.ctx.strokeRect(a[0],a[1],a[2]-a[0],a[3]-a[1]),this.ctx.restore()},checkBox:function(a){for(var b=0,c=this.buffer.length,g;b<c;b++)if(g=this.buffer[b],!(a[4]&&
a[4]==g[4])&&g[0]<=a[2]&&g[1]<=a[3]&&g[2]>=a[0]&&g[3]>=a[1]){if(this.debugChecks)this.ctx.save(),this.ctx.strokeStyle="darkblue",this.ctx.lineWidth="1",this.ctx.strokeRect(a[0],a[1],a[2]-a[0],a[3]-a[1]),this.ctx.restore();return!0}return!1},checkPointWH:function(a,b,c,g){return this.checkBox(this.getBoxFromPoint(a,b,c,0,g))},getBoxFromPoint:function(a,b,c,g,q){return[a[0]-b/2-g,a[1]-c/2-g,a[0]+b/2+g,a[1]+c/2+g,q]}};return function(a,q,h,g,r,z){var a=typeof a=="string"?document.getElementById(a):a,
j=a.getContext("2d"),o=a.width,l=a.height,k=q.granularity,A=o/k,s=l/k,B={},F=[],D=new t,I,G,H=+new Date,J,K,L;if(z)I=document.createElement("canvas"),I.width=o,I.height=l,G=j,j=I.getContext("2d");d(B,F,q,h,g);J=+new Date;e(j,f);var M=F.length,E,p,v,C,x,N;N=function(){D.addBox([0,0,o,0]);D.addBox([0,l,o,l]);D.addBox([o,0,o,l]);D.addBox([0,0,0,l]);for(E=M-1;E>=0;E--){v=B[F[E]];C=v.length;for(p=C-1;p>=0;p--)x=v[p].style,"icon-image"in x&&!x.text&&b(j,v[p],D,A,s,k,!1,!0);for(p=C-1;p>=0;p--)x=v[p].style,
x.text&&x["text-position"]=="line"&&b(j,v[p],D,A,s,k,!0,!1);for(p=C-1;p>=0;p--)x=v[p].style,x.text&&x["text-position"]!="line"&&!("icon-image"in x)&&b(j,v[p],D,A,s,k,!0,!1);for(p=C-1;p>=0;p--)x=v[p].style,"icon-image"in x&&x.text&&b(j,v[p],D,A,s,k,!0,!0)}L=+new Date;z&&G.drawImage(I,0,0);r({layersStyled:J-H,mapRendered:K-J,iconsAndTextRendered:L-K,total:L-H})};setTimeout(function(){m(j,o,l,h);for(E=0;E<M;E++){v=B[F[E]];C=v.length;for(p=0;p<C;p++)x=v[p].style,("fill-color"in x||"fill-image"in x)&&
c(j,v[p],v[p+1],A,s,k);j.lineCap="butt";for(p=0;p<C;p++)if("casing-width"in v[p].style){var a=j,b=v[p],g=v[p+1],i=A,q=s,t=k,f=b.style,d=g&&g.style,r=f["casing-dashes"]||f.dashes||!1;n||(n=!0,a.beginPath());Kothic.path(a,b,r,!1,i,q,t);if(!g||!(d.width===f.width&&d["casing-width"]===f["casing-width"]&&d["casing-color"]===f["casing-color"]&&d["casing-opacity"]===f["casing-opacity"]))a.save(),e(a,{lineWidth:2*f["casing-width"]+("width"in f?f.width:0),strokeStyle:f["casing-color"],lineCap:f["casing-linecap"]||
f.linecap,lineJoin:f["casing-linejoin"]||f.linejoin,globalAlpha:f["casing-opacity"]}),n=!1,a.stroke(),a.restore()}j.lineCap="round";for(p=0;p<C;p++)if("width"in v[p].style&&(a=j,b=v[p],g=v[p+1],i=A,q=s,t=k,f=b.style,d=g&&g.style,r=f.dashes,n||(n=!0,a.beginPath()),Kothic.path(a,b,r,!1,i,q,t),!g||!(d.width===f.width&&d.color===f.color&&d.opacity===f.opacity)))a.save(),e(a,{lineWidth:f.width,strokeStyle:f.color,lineCap:f.linecap,lineJoin:f.linejoin,globalAlpha:f.opacity}),n=!1,a.stroke(),a.restore();
K=+new Date}setTimeout(N,0)},0)}}();var MapCSS={styles:{},currentStyle:"",onError:function(){},onImagesLoad:function(){},e_min:function(){return Math.min.apply(null,arguments)},e_max:function(){return Math.max.apply(null,arguments)},e_any:function(){for(var a=0;a<arguments.length;a++)if(typeof arguments[a]!="undefined"&&arguments[a]!=="")return arguments[a];return""},e_num:function(a){return isNaN(parseFloat(a))?"":parseFloat(a)},e_str:function(a){return a},e_int:function(a){return parseInt(a,10)},e_tag:function(a,d){return d in a&&
a[d]!==null?a[d]:""},e_prop:function(a,d){return d in a&&a[d]!==null?a[d]:""},e_sqrt:function(a){return Math.sqrt(a)},e_boolean:function(a){return a=="0"||a=="false"||a===""?"false":"true"},e_boolean:function(a,d,e){return MapCSS.e_boolean(a)=="true"?d:e},e_metric:function(a){return/\d\s*mm$/.test(a)?1E3*parseInt(a,10):/\d\s*cm$/.test(a)?100*parseInt(a,10):/\d\s*dm$/.test(a)?10*parseInt(a,10):/\d\s*km$/.test(a)?0.0010*parseInt(a,10):/\d\s*in$/.test(a)?0.0254*parseInt(a,10):/\d\s*ft$/.test(a)?0.3048*
parseInt(a,10):parseInt(a,10)},e_zmetric:function(a){return MapCSS.metric(a)},loadStyle:function(a,d,e,h){MapCSS.styles[a]={restyle:d,images:e,external_images:h,textures:{}};if(!MapCSS.currentStyle)MapCSS.currentStyle=a},loadImages:function(a,d){var e=!d,h=!MapCSS.styles[a].external_images.length;if(h&&e)MapCSS.onImagesLoad();h||MapCSS._preloadExternalImages(a,function(){if((h=!0)&&e)MapCSS.onImagesLoad()});e||MapCSS._preloadSpriteImage(a,d,function(){e=!0;if(h&&e)MapCSS.onImagesLoad()})},_preloadSpriteImage:function(a,
d,e){var h=new Image;h.onload=function(){var m=MapCSS.styles[a].images,c;for(c in m)if(m.hasOwnProperty(c))m[c].sprite=h;e()};h.onerror=function(a){MapCSS.onError(a)};h.src=d},_preloadExternalImages:function(a,d){var e=MapCSS.styles[a].external_images;delete MapCSS.styles[a].external_images;for(var h=e.length,m=0,c=0;c<h;c++)(function(c){var b=new Image;b.onload=function(){m++;MapCSS.styles[a].images[c]={sprite:b,height:b.height,width:b.width,offset:0};m==h&&d()};b.onerror=function(){m++;m==h&&d()};
b.src=c})(e[c])},getImage:function(a){var d=MapCSS.styles[MapCSS.currentStyle],e=d.images[a];if(e.sprite){var h=document.createElement("canvas");h.width=e.width;h.height=e.height;h.getContext("2d").drawImage(e.sprite,0,e.offset,e.width,e.height,0,0,e.width,e.height);e=d.images[a]=h}return e},restyle:function(){return MapCSS.styles[MapCSS.currentStyle].restyle.apply(MapCSS,arguments)}};Kothic.path=function(){function a(a,c){h={pattern:c,seg:0,phs:0,x:a[0],y:a[1]}}function d(a,c){var e=h,b=c[0]-e.x,q=c[1]-e.y,n=Math.sqrt(b*b+q*q),d;a.save();a.translate(e.x,e.y);a.rotate(Math.atan2(q,b));a.moveTo(0,0);b=0;do{d=e.pattern[e.seg];b+=d-e.phs;q=b<n;if(!q)e.phs=d-(b-n),b=n;a[e.seg%2?"moveTo":"lineTo"](b,0);if(q)e.phs=0,e.seg=++e.seg%e.pattern.length}while(q);e.x=c[0];e.y=c[1];a.restore()}function e(a,c){return a[0]===0||a[0]==c||a[1]===0||a[1]==c}var h;return function(h,c,t,b,q,n,r){var f=
c.type,c=c.coordinates;f=="Polygon"&&(c=[c],f="MultiPolygon");f=="LineString"&&(c=[c],f="MultiLineString");var i,u,y,g,w=c.length,z,j,o,l,k;if(f=="MultiPolygon")for(i=0;i<w;i++){y=0;for(z=c[i].length;y<z;y++){g=c[i][y];j=g.length;o=g[0];for(u=0;u<=j;u++)l=g[u]||g[0],k=[q*l[0],n*(r-l[1])],u===0||!b&&e(l,r)&&e(o,r)?(o=t,h.moveTo(k[0],k[1]),o&&a(k,o)):b||!t?h.lineTo(k[0],k[1]):d(h,k),o=l}}if(f=="MultiLineString")for(i=0;i<w;i++){g=c[i];j=g.length;for(u=0;u<j;u++){l=g[u];k=[q*l[0],n*(r-l[1])];if((u===
0||u==j-1)&&e(l,r))o=g[u?j-2:1],b=l[0]-o[0],f=l[1]-o[1],l=Math.sqrt(b*b+f*f),k=[k[0]+10*b/l,k[1]-10*f/l];u===0?(b=k,f=t,h.moveTo(b[0],b[1]),f&&a(b,f)):t?d(h,k):h.lineTo(k[0],k[1])}}}}();/*
 Use it if you like it
*/
function RGBColor(a,d){this.ok=!1;a.charAt(0)=="#"&&(a=a.substr(1,6));var a=a.replace(/ /g,""),a=a.toLowerCase(),e={aliceblue:"f0f8ff",antiquewhite:"faebd7",aqua:"00ffff",aquamarine:"7fffd4",azure:"f0ffff",beige:"f5f5dc",bisque:"ffe4c4",black:"000000",blanchedalmond:"ffebcd",blue:"0000ff",blueviolet:"8a2be2",brown:"a52a2a",burlywood:"deb887",cadetblue:"5f9ea0",chartreuse:"7fff00",chocolate:"d2691e",coral:"ff7f50",cornflowerblue:"6495ed",cornsilk:"fff8dc",crimson:"dc143c",cyan:"00ffff",darkblue:"00008b",
darkcyan:"008b8b",darkgoldenrod:"b8860b",darkgray:"a9a9a9",darkgreen:"006400",darkkhaki:"bdb76b",darkmagenta:"8b008b",darkolivegreen:"556b2f",darkorange:"ff8c00",darkorchid:"9932cc",darkred:"8b0000",darksalmon:"e9967a",darkseagreen:"8fbc8f",darkslateblue:"483d8b",darkslategray:"2f4f4f",darkturquoise:"00ced1",darkviolet:"9400d3",deeppink:"ff1493",deepskyblue:"00bfff",dimgray:"696969",dodgerblue:"1e90ff",feldspar:"d19275",firebrick:"b22222",floralwhite:"fffaf0",forestgreen:"228b22",fuchsia:"ff00ff",
gainsboro:"dcdcdc",ghostwhite:"f8f8ff",gold:"ffd700",goldenrod:"daa520",gray:"808080",green:"008000",greenyellow:"adff2f",honeydew:"f0fff0",hotpink:"ff69b4",indianred:"cd5c5c",indigo:"4b0082",ivory:"fffff0",khaki:"f0e68c",lavender:"e6e6fa",lavenderblush:"fff0f5",lawngreen:"7cfc00",lemonchiffon:"fffacd",lightblue:"add8e6",lightcoral:"f08080",lightcyan:"e0ffff",lightgoldenrodyellow:"fafad2",lightgrey:"d3d3d3",lightgreen:"90ee90",lightpink:"ffb6c1",lightsalmon:"ffa07a",lightseagreen:"20b2aa",lightskyblue:"87cefa",
lightslateblue:"8470ff",lightslategray:"778899",lightsteelblue:"b0c4de",lightyellow:"ffffe0",lime:"00ff00",limegreen:"32cd32",linen:"faf0e6",magenta:"ff00ff",maroon:"800000",mediumaquamarine:"66cdaa",mediumblue:"0000cd",mediumorchid:"ba55d3",mediumpurple:"9370d8",mediumseagreen:"3cb371",mediumslateblue:"7b68ee",mediumspringgreen:"00fa9a",mediumturquoise:"48d1cc",mediumvioletred:"c71585",midnightblue:"191970",mintcream:"f5fffa",mistyrose:"ffe4e1",moccasin:"ffe4b5",navajowhite:"ffdead",navy:"000080",
oldlace:"fdf5e6",olive:"808000",olivedrab:"6b8e23",orange:"ffa500",orangered:"ff4500",orchid:"da70d6",palegoldenrod:"eee8aa",palegreen:"98fb98",paleturquoise:"afeeee",palevioletred:"d87093",papayawhip:"ffefd5",peachpuff:"ffdab9",peru:"cd853f",pink:"ffc0cb",plum:"dda0dd",powderblue:"b0e0e6",purple:"800080",red:"ff0000",rosybrown:"bc8f8f",royalblue:"4169e1",saddlebrown:"8b4513",salmon:"fa8072",sandybrown:"f4a460",seagreen:"2e8b57",seashell:"fff5ee",sienna:"a0522d",silver:"c0c0c0",skyblue:"87ceeb",slateblue:"6a5acd",
slategray:"708090",snow:"fffafa",springgreen:"00ff7f",steelblue:"4682b4",tan:"d2b48c",teal:"008080",thistle:"d8bfd8",tomato:"ff6347",turquoise:"40e0d0",violet:"ee82ee",violetred:"d02090",wheat:"f5deb3",white:"ffffff",whitesmoke:"f5f5f5",yellow:"ffff00",yellowgreen:"9acd32"};e[a]&&(a=e[a]);for(var e=[{re:/^rgb\((\d{1,3}),\s*(\d{1,3}),\s*(\d{1,3})\)$/,example:["rgb(123, 234, 45)","rgb(255,234,245)"],process:function(a){return[parseInt(a[1]),parseInt(a[2]),parseInt(a[3])]}},{re:/^(\w{2})(\w{2})(\w{2})$/,
example:["#00ff00","336699"],process:function(a){return[parseInt(a[1],16),parseInt(a[2],16),parseInt(a[3],16)]}},{re:/^(\w{1})(\w{1})(\w{1})$/,example:["#fb0","f0f"],process:function(a){return[parseInt(a[1]+a[1],16),parseInt(a[2]+a[2],16),parseInt(a[3]+a[3],16)]}}],h=0;h<e.length;h++){var m=e[h].process,c=e[h].re.exec(a);if(c)channels=m(c),this.r=channels[0],this.g=channels[1],this.b=channels[2],this.ok=!0}this.r=this.r<0||isNaN(this.r)?0:this.r>255?255:this.r;this.g=this.g<0||isNaN(this.g)?0:this.g>
255?255:this.g;this.b=this.b<0||isNaN(this.b)?0:this.b>255?255:this.b;this.a=d?d:1;this.toRGB=function(){return"rgb("+this.r+", "+this.g+", "+this.b+")"};this.toRGBA=function(){return"rgba("+this.r+", "+this.g+", "+this.b+", "+this.a+")"};this.toHex=function(){var a=this.r.toString(16),b=this.g.toString(16),c=this.b.toString(16);a.length==1&&(a="0"+a);b.length==1&&(b="0"+b);c.length==1&&(c="0"+c);return"#"+a+b+c}};Kothic.textOnPath=function(){function a(a,c){if(!t[c])t[c]=a.measureText(c).width;return t[c]}function d(a,c){return[a[1]+0.5*Math.cos(a[0])*c,a[2]+0.5*Math.sin(a[0])*c]}function e(b,c,e,h){var h=h||0,f=a(b,c),c=a(b,c.charAt(0))*1.5,i=e[0],b=Math.abs(Math.cos(i)*f)+Math.abs(Math.sin(i)*c),c=Math.abs(Math.sin(i)*f)+Math.abs(Math.cos(i)*c);return[d(e,f+2*h),b,c,0]}function h(b,c,h,d){var f,i=0;for(f=0;f<=h.length;f++){if(b.checkPointWH.apply(b,e(c,h.charAt(f),d,i)))return!0;i+=a(c,h.charAt(f))}return!1}
function m(b,c,e){var h=c[4],f=d(c,a(b,h));b.save();b.translate(Math.floor(f[0]),Math.floor(f[1]));b.rotate(c[0]);b[e?"strokeText":"fillText"](h,0,0);b.restore()}function c(a,c){var e=a.length,h,f,i,d,m,g=0;m=0;for(d=1;d<e;d++){m=a[d];i=a[d-1];h=m[0]-i[0];f=m[1]-i[1];m=Math.sqrt(h*h+f*f);if(g+m>=c)return d=c-g,e=i[0]+h*d/m,i=i[1]+f*d/m,h=Math.atan2(f,h),[h,e,i,m-d];g+=m}}var t;return function(b,d,n,r,f){t={};var i=b.measureText(n).width,u=n.length,y,g=d.length,w,z,j,o=0;for(j=1;j<g;j++)w=d[j],z=d[j-
1],y=z[0]-w[0],w=z[1]-w[1],o+=Math.sqrt(y*y+w*w);y=o;if(!(y<i)){for(var l,k=0,A,s=!1,B,F=Math.PI/6;k<2;){w=k?a(b,n.charAt(0)):(y-i)/2;A=0;z=null;l=[];for(g=0;g<u;g++){j=c(d,w);if(w>=y||!j){k++;l=[];s&&(d.reverse(),s=!1);break}z||(z=j[0]);o=n.charAt(g);B=a(b,o);if(h(f,b,o,j)||Math.abs(z-j[0])>F)w+=B,g=-1,l=[],A=0;else{for(;B<j[3]&&g<u;)if(g++,o+=n.charAt(g),B=a(b,o),h(f,b,o,j)||Math.abs(z-j[0])>F){g=0;w+=B;l=[];A=0;o=n.charAt(g);B=a(b,o);j=c(d,w);break}if(j){if(j[0]>Math.PI/2||j[0]<-Math.PI/2)A+=o.length;
z=j[0];j.push(o);l.push(j);w+=B}}}A>u/2&&(d.reverse(),l=[],s?(k++,d.reverse(),s=!1):s=!0);if(k>=2)return;if(l.length>0)break}d=l.length;for(g=0;r&&g<d;g++)m(b,l[g],!0);for(g=0;g<d;g++){j=l[g];m(b,j);r=f;n=b;i=j[4];u=j;j=void 0;for(j=y=0;j<=i.length;j++)r.addPointWH.apply(r,e(n,i.charAt(j),u,y)),y+=a(n,i.charAt(j))}}}}();
