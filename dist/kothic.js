/*
 Copyright (c) 2011, Darafei Praliaskouski, Vladimir Agafonkin, Maksim Gurtovenko
 Kothic JS is a full-featured JavaScript map rendering engine using HTML5 Canvas.
 See http://github.com/kothic/kothic-js for more information.
*/
var Kothic={};
Kothic.render=function(){function a(f,a){return parseFloat(f.style["z-index"]||0)-parseFloat(a.style["z-index"]||0)}function j(f,u,b,d,n){var c=b.features,b=[],g,q,s,m,o,t;g=0;for(s=c.length;g<s;g++){o=m=c[g];t=d;var h=n,l=0;if(h)l=h.kothicId=h.kothicId||++w;var r=void 0,e=void 0,l=[MapCSS.currentStyle,l,JSON.stringify(o.properties),t,o.type].join(":");if(!k[l]){if(o.type=="Polygon"||o.type=="MultiPolygon")r="way",e="area";else if(o.type=="LineString"||o.type=="MultiLineString")r="way",e="line";else if(o.type==
"Point"||o.type=="MultiPoint")e=r="node";k[l]=MapCSS.restyle(o.properties,t,r,e);h&&h(k[l],o.properties,t,r,e)}o=k[l];for(q in o)if(o.hasOwnProperty(q)){t={};h=m;r=void 0;for(r in h)h.hasOwnProperty(r)&&(t[r]=h[r]);t.kothicId=g+1;t.style=o[q];b.push(t)}}b.sort(a);d=0;for(n=b.length;d<n;d++)q=b[d],c=parseFloat(q.properties.layer)||0,g=q.style["-x-mapnik-layer"],g=="top"&&(c=1E4),g=="bottom"&&(c=-1E4),c in f||(f[c]=[],u.push(c)),f[c].push(q);u.sort()}function c(f,a){for(var b in a)a.hasOwnProperty(b)&&
a[b]&&(f[b]=a[b])}function e(f,a,b){var d=a["fill-opacity"]||a.opacity;f.save();"fill-color"in a&&(c(f,{fillStyle:a["fill-color"],globalAlpha:d}),b());"fill-image"in a&&((a=MapCSS.getImage(a["fill-image"]))&&c(f,{fillStyle:f.createPattern(a,"repeat"),globalAlpha:d}),b());f.restore()}function o(f,a,b,d){d=MapCSS.restyle({},d,"canvas","canvas")["default"];f.save();e(f,d,function(){f.fillRect(-1,-1,a+1,b+1)});f.restore()}function l(f,a,b,d,k,c){var g=a.style,o=b&&b.style;h||(h=!0,f.beginPath());Kothic.path(f,
a,!1,!0,d,k,c);if(!b||!(o["fill-color"]===g["fill-color"]&&o["fill-image"]===g["fill-image"]&&o["fill-opacity"]===g["fill-opacity"]))f.save(),e(f,g,function(){f.fill()}),f.restore(),h=!1}function n(f,a,b){this.buffer=[];this.ctx=f;this.debugBoxes=a;this.debugChecks=b}function b(f,a,b,d,k,o,g,n){var h=a.style,m;a:switch(a.type){case "Point":m=a.coordinates;break;case "Polygon":m=a.reprpoint;break;case "LineString":m=a.coordinates[0];break;case "GeometryCollection":case "MultiPoint":case "MultiPolygon":case "MultiLineString":m=
void 0;break a}if(m){m=[d*m[0],k*(o-m[1])];var l;if(n){l=MapCSS.getImage(h["icon-image"]);if(!l)return;if(h["allow-overlap"]!="true"&&b.checkPointWH(m,l.width,l.height,a.kothicId))return}if(g){f.save();var g=h["text-halo-radius"]+2,e;e=h["font-family"];var i=h["font-size"];e=e||"";var i=i||9,j=e?e+", ":"";e=e.toLowerCase();var r=[];(e.indexOf("italic")!=-1||e.indexOf("oblique")!=-1)&&r.push("italic");e.indexOf("bold")!=-1&&r.push("bold");r.push(i+"px");j+=e.indexOf("serif")!=-1?"Georgia, serif":"Arial, Helvetica, sans-serif";
r.push(j);e=r.join(" ");c(f,{lineWidth:g,font:e});g=h.text+"";i=f.measureText(g).width;j=i/g.length*2.5;r=h["text-offset"]||0;if(h["text-allow-overlap"]!="true"&&b.checkPointWH([m[0],m[1]+r],i,j,a.kothicId)){f.restore();return}var w=h["text-opacity"]||h.opacity||1,G=h["text-color"]||"#000000",H=h["text-halo-color"]||"#ffffff";e="text-halo-radius"in h;w<1&&(G=(new RGBColor(G,w)).toRGBA(),H=(new RGBColor(H,w)).toRGBA());c(f,{fillStyle:G,strokeStyle:H,textAlign:"center",textBaseline:"middle"});if(a.type==
"Polygon"||a.type=="Point")e&&f.strokeText(g,m[0],m[1]+r),f.fillText(g,m[0],m[1]+r),d=parseFloat(h["-x-mapnik-min-distance"])||20,b.addPointWH([m[0],m[1]+r],i,j,d,a.kothicId);else if(a.type=="LineString"){i=a.coordinates;j=[];r=0;for(w=i.length;r<w;r++)j.push([d*i[r][0],k*(o-i[r][1])]);Kothic.textOnPath(f,j,g,e,b)}f.restore()}n&&(f.drawImage(l,Math.floor(m[0]-l.width/2),Math.floor(m[1]-l.height/2)),d=parseFloat(h["-x-mapnik-min-distance"])||0,b.addPointWH(m,l.width,l.height,d,a.kothicId))}}var k=
{},h=!1,w=0,i={strokeStyle:"rgba(0,0,0,0.5)",fillStyle:"rgba(0,0,0,0.5)",lineWidth:1,lineCap:"round",lineJoin:"round"};n.prototype={addBox:function(a){this.buffer.push(a)},addPointWH:function(a,b,h,d,k){a=this.getBoxFromPoint(a,b,h,d,k);this.buffer.push(a);if(this.debugBoxes)this.ctx.save(),this.ctx.strokeStyle="red",this.ctx.lineWidth="1",this.ctx.strokeRect(a[0],a[1],a[2]-a[0],a[3]-a[1]),this.ctx.restore()},checkBox:function(a){for(var b=0,h=this.buffer.length,d;b<h;b++)if(d=this.buffer[b],!(a[4]&&
a[4]==d[4])&&d[0]<=a[2]&&d[1]<=a[3]&&d[2]>=a[0]&&d[3]>=a[1]){if(this.debugChecks)this.ctx.save(),this.ctx.strokeStyle="darkblue",this.ctx.lineWidth="1",this.ctx.strokeRect(a[0],a[1],a[2]-a[0],a[3]-a[1]),this.ctx.restore();return!0}return!1},checkPointWH:function(a,b,h,d){return this.checkBox(this.getBoxFromPoint(a,b,h,0,d))},getBoxFromPoint:function(a,b,h,d,k){return[a[0]-b/2-d,a[1]-h/2-d,a[0]+b/2+d,a[1]+h/2+d,k]}};return function(a,k,e,d,w,A){var a=typeof a=="string"?document.getElementById(a):a,
g=a.getContext("2d"),q=a.width,s=a.height,m=k.granularity,B=q/m,t=s/m,C={},F=[],r=new n,I,G,H=+new Date,J,K,L;if(A)I=document.createElement("canvas"),I.width=q,I.height=s,G=g,g=I.getContext("2d");j(C,F,k,e,d);J=+new Date;c(g,i);var M=F.length,E,p,v,D,y,N;N=function(){r.addBox([0,0,q,0]);r.addBox([0,s,q,s]);r.addBox([q,0,q,s]);r.addBox([0,0,0,s]);for(E=M-1;E>=0;E--){v=C[F[E]];D=v.length;for(p=D-1;p>=0;p--)y=v[p].style,"icon-image"in y&&!y.text&&b(g,v[p],r,B,t,m,!1,!0);for(p=D-1;p>=0;p--)y=v[p].style,
y.text&&y["text-position"]=="line"&&b(g,v[p],r,B,t,m,!0,!1);for(p=D-1;p>=0;p--)y=v[p].style,y.text&&y["text-position"]!="line"&&!("icon-image"in y)&&b(g,v[p],r,B,t,m,!0,!1);for(p=D-1;p>=0;p--)y=v[p].style,"icon-image"in y&&y.text&&b(g,v[p],r,B,t,m,!0,!0)}L=+new Date;A&&G.drawImage(I,0,0);w({layersStyled:J-H,mapRendered:K-J,iconsAndTextRendered:L-K,total:L-H})};setTimeout(function(){o(g,q,s,e);for(E=0;E<M;E++){v=C[F[E]];D=v.length;for(p=0;p<D;p++)y=v[p].style,("fill-color"in y||"fill-image"in y)&&
l(g,v[p],v[p+1],B,t,m);g.lineCap="butt";for(p=0;p<D;p++)if("casing-width"in v[p].style){var a=g,b=v[p],d=v[p+1],f=B,k=t,n=m,i=b.style,j=d&&d.style,w=i["casing-dashes"]||i.dashes||!1;h||(h=!0,a.beginPath());Kothic.path(a,b,w,!1,f,k,n);if(!d||!(j.width===i.width&&j["casing-width"]===i["casing-width"]&&j["casing-color"]===i["casing-color"]&&j["casing-opacity"]===i["casing-opacity"]))a.save(),c(a,{lineWidth:2*i["casing-width"]+("width"in i?i.width:0),strokeStyle:i["casing-color"],lineCap:i["casing-linecap"]||
i.linecap,lineJoin:i["casing-linejoin"]||i.linejoin,globalAlpha:i["casing-opacity"]}),h=!1,a.stroke(),a.restore()}g.lineCap="round";for(p=0;p<D;p++)if("width"in v[p].style&&(a=g,b=v[p],d=v[p+1],f=B,k=t,n=m,i=b.style,j=d&&d.style,w=i.dashes,h||(h=!0,a.beginPath()),Kothic.path(a,b,w,!1,f,k,n),!d||!(j.width===i.width&&j.color===i.color&&j.opacity===i.opacity)))a.save(),c(a,{lineWidth:i.width,strokeStyle:i.color,lineCap:i.linecap,lineJoin:i.linejoin,globalAlpha:i.opacity}),h=!1,a.stroke(),a.restore();
K=+new Date}setTimeout(N,0)},0)}}();var MapCSS={styles:{},currentStyle:"",onError:function(){},onImagesLoad:function(){},e_min:function(){return Math.min.apply(null,arguments)},e_max:function(){return Math.max.apply(null,arguments)},e_any:function(){for(var a=0;a<arguments.length;a++)if(typeof arguments[a]!="undefined"&&arguments[a]!=="")return arguments[a];return""},e_num:function(a){return isNaN(parseFloat(a))?"":parseFloat(a)},e_str:function(a){return a},e_int:function(a){return parseInt(a,10)},e_tag:function(a,j){return j in a&&
a[j]!==null?a[j]:""},e_prop:function(a,j){return j in a&&a[j]!==null?a[j]:""},e_sqrt:function(a){return Math.sqrt(a)},e_boolean:function(a){return a=="0"||a=="false"||a===""?"false":"true"},e_boolean:function(a,j,c){return MapCSS.e_boolean(a)=="true"?j:c},e_metric:function(a){return/\d\s*mm$/.test(a)?1E3*parseInt(a,10):/\d\s*cm$/.test(a)?100*parseInt(a,10):/\d\s*dm$/.test(a)?10*parseInt(a,10):/\d\s*km$/.test(a)?0.0010*parseInt(a,10):/\d\s*in$/.test(a)?0.0254*parseInt(a,10):/\d\s*ft$/.test(a)?0.3048*
parseInt(a,10):parseInt(a,10)},e_zmetric:function(a){return MapCSS.metric(a)},loadStyle:function(a,j,c,e){MapCSS.styles[a]={restyle:j,images:c,external_images:e,textures:{}};if(!MapCSS.currentStyle)MapCSS.currentStyle=a},loadImages:function(a,j){var c=!j,e=!MapCSS.styles[a].external_images.length;if(e&&c)MapCSS.onImagesLoad();e||MapCSS._preloadExternalImages(a,function(){if((e=!0)&&c)MapCSS.onImagesLoad()});c||MapCSS._preloadSpriteImage(a,j,function(){c=!0;if(e&&c)MapCSS.onImagesLoad()})},_preloadSpriteImage:function(a,
j,c){var e=new Image;e.onload=function(){var o=MapCSS.styles[a].images,l;for(l in o)if(o.hasOwnProperty(l))o[l].sprite=e;c()};e.onerror=function(a){MapCSS.onError(a)};e.src=j},_preloadExternalImages:function(a,j){var c=MapCSS.styles[a].external_images;delete MapCSS.styles[a].external_images;for(var e=c.length,o=0,l=0;l<e;l++)(function(n){var b=new Image;b.onload=function(){o++;MapCSS.styles[a].images[n]={sprite:b,height:b.height,width:b.width,offset:0};o==e&&j()};b.onerror=function(){o++;o==e&&j()};
b.src=n})(c[l])},getImage:function(a){var j=MapCSS.styles[MapCSS.currentStyle],c=j.images[a];if(c.sprite){var e=document.createElement("canvas");e.width=c.width;e.height=c.height;e.getContext("2d").drawImage(c.sprite,0,c.offset,c.width,c.height,0,0,c.width,c.height);c=j.images[a]=e}return c},restyle:function(){return MapCSS.styles[MapCSS.currentStyle].restyle.apply(MapCSS,arguments)}};Kothic.path=function(){function a(a,c){e={pattern:c,seg:0,phs:0,x:a[0],y:a[1]}}function j(a,c){var n=e,b=c[0]-n.x,k=c[1]-n.y,h=Math.sqrt(b*b+k*k),j;a.save();a.translate(n.x,n.y);a.rotate(Math.atan2(k,b));a.moveTo(0,0);b=0;do{j=n.pattern[n.seg];b+=j-n.phs;k=b<h;if(!k)n.phs=j-(b-h),b=h;a[n.seg%2?"moveTo":"lineTo"](b,0);if(k)n.phs=0,n.seg=++n.seg%n.pattern.length}while(k);n.x=c[0];n.y=c[1];a.restore()}function c(a,c){return a[0]===0||a[0]==c||a[1]===0||a[1]==c}var e;return function(e,l,n,b,k,h,w){var i=
l.type,l=l.coordinates;i=="Polygon"&&(l=[l],i="MultiPolygon");i=="LineString"&&(l=[l],i="MultiLineString");var f,u,z,d,x=l.length,A,g,q,s,m;if(i=="MultiPolygon")for(f=0;f<x;f++){z=0;for(A=l[f].length;z<A;z++){d=l[f][z];g=d.length;q=d[0];for(u=0;u<=g;u++)s=d[u]||d[0],m=[k*s[0],h*(w-s[1])],u===0||!b&&c(s,w)&&c(q,w)?(q=m,m=n,e.moveTo(q[0],q[1]),m&&a(q,m)):b||!n?e.lineTo(m[0],m[1]):j(e,m),q=s}}if(i=="MultiLineString")for(f=0;f<x;f++){d=l[f];g=d.length;for(u=0;u<g;u++)s=d[u],m=[k*s[0],h*(w-s[1])],(u===
0||u==g-1)&&c(s,w),u===0?(b=m,i=n,e.moveTo(b[0],b[1]),i&&a(b,i)):n?j(e,m):e.lineTo(m[0],m[1])}}}();/*
 Use it if you like it
*/
function RGBColor(a,j){this.ok=!1;a.charAt(0)=="#"&&(a=a.substr(1,6));var a=a.replace(/ /g,""),a=a.toLowerCase(),c={aliceblue:"f0f8ff",antiquewhite:"faebd7",aqua:"00ffff",aquamarine:"7fffd4",azure:"f0ffff",beige:"f5f5dc",bisque:"ffe4c4",black:"000000",blanchedalmond:"ffebcd",blue:"0000ff",blueviolet:"8a2be2",brown:"a52a2a",burlywood:"deb887",cadetblue:"5f9ea0",chartreuse:"7fff00",chocolate:"d2691e",coral:"ff7f50",cornflowerblue:"6495ed",cornsilk:"fff8dc",crimson:"dc143c",cyan:"00ffff",darkblue:"00008b",
darkcyan:"008b8b",darkgoldenrod:"b8860b",darkgray:"a9a9a9",darkgreen:"006400",darkkhaki:"bdb76b",darkmagenta:"8b008b",darkolivegreen:"556b2f",darkorange:"ff8c00",darkorchid:"9932cc",darkred:"8b0000",darksalmon:"e9967a",darkseagreen:"8fbc8f",darkslateblue:"483d8b",darkslategray:"2f4f4f",darkturquoise:"00ced1",darkviolet:"9400d3",deeppink:"ff1493",deepskyblue:"00bfff",dimgray:"696969",dodgerblue:"1e90ff",feldspar:"d19275",firebrick:"b22222",floralwhite:"fffaf0",forestgreen:"228b22",fuchsia:"ff00ff",
gainsboro:"dcdcdc",ghostwhite:"f8f8ff",gold:"ffd700",goldenrod:"daa520",gray:"808080",green:"008000",greenyellow:"adff2f",honeydew:"f0fff0",hotpink:"ff69b4",indianred:"cd5c5c",indigo:"4b0082",ivory:"fffff0",khaki:"f0e68c",lavender:"e6e6fa",lavenderblush:"fff0f5",lawngreen:"7cfc00",lemonchiffon:"fffacd",lightblue:"add8e6",lightcoral:"f08080",lightcyan:"e0ffff",lightgoldenrodyellow:"fafad2",lightgrey:"d3d3d3",lightgreen:"90ee90",lightpink:"ffb6c1",lightsalmon:"ffa07a",lightseagreen:"20b2aa",lightskyblue:"87cefa",
lightslateblue:"8470ff",lightslategray:"778899",lightsteelblue:"b0c4de",lightyellow:"ffffe0",lime:"00ff00",limegreen:"32cd32",linen:"faf0e6",magenta:"ff00ff",maroon:"800000",mediumaquamarine:"66cdaa",mediumblue:"0000cd",mediumorchid:"ba55d3",mediumpurple:"9370d8",mediumseagreen:"3cb371",mediumslateblue:"7b68ee",mediumspringgreen:"00fa9a",mediumturquoise:"48d1cc",mediumvioletred:"c71585",midnightblue:"191970",mintcream:"f5fffa",mistyrose:"ffe4e1",moccasin:"ffe4b5",navajowhite:"ffdead",navy:"000080",
oldlace:"fdf5e6",olive:"808000",olivedrab:"6b8e23",orange:"ffa500",orangered:"ff4500",orchid:"da70d6",palegoldenrod:"eee8aa",palegreen:"98fb98",paleturquoise:"afeeee",palevioletred:"d87093",papayawhip:"ffefd5",peachpuff:"ffdab9",peru:"cd853f",pink:"ffc0cb",plum:"dda0dd",powderblue:"b0e0e6",purple:"800080",red:"ff0000",rosybrown:"bc8f8f",royalblue:"4169e1",saddlebrown:"8b4513",salmon:"fa8072",sandybrown:"f4a460",seagreen:"2e8b57",seashell:"fff5ee",sienna:"a0522d",silver:"c0c0c0",skyblue:"87ceeb",slateblue:"6a5acd",
slategray:"708090",snow:"fffafa",springgreen:"00ff7f",steelblue:"4682b4",tan:"d2b48c",teal:"008080",thistle:"d8bfd8",tomato:"ff6347",turquoise:"40e0d0",violet:"ee82ee",violetred:"d02090",wheat:"f5deb3",white:"ffffff",whitesmoke:"f5f5f5",yellow:"ffff00",yellowgreen:"9acd32"};c[a]&&(a=c[a]);for(var c=[{re:/^rgb\((\d{1,3}),\s*(\d{1,3}),\s*(\d{1,3})\)$/,example:["rgb(123, 234, 45)","rgb(255,234,245)"],process:function(a){return[parseInt(a[1]),parseInt(a[2]),parseInt(a[3])]}},{re:/^(\w{2})(\w{2})(\w{2})$/,
example:["#00ff00","336699"],process:function(a){return[parseInt(a[1],16),parseInt(a[2],16),parseInt(a[3],16)]}},{re:/^(\w{1})(\w{1})(\w{1})$/,example:["#fb0","f0f"],process:function(a){return[parseInt(a[1]+a[1],16),parseInt(a[2]+a[2],16),parseInt(a[3]+a[3],16)]}}],e=0;e<c.length;e++){var o=c[e].process,l=c[e].re.exec(a);if(l)channels=o(l),this.r=channels[0],this.g=channels[1],this.b=channels[2],this.ok=!0}this.r=this.r<0||isNaN(this.r)?0:this.r>255?255:this.r;this.g=this.g<0||isNaN(this.g)?0:this.g>
255?255:this.g;this.b=this.b<0||isNaN(this.b)?0:this.b>255?255:this.b;this.a=j?j:1;this.toRGB=function(){return"rgb("+this.r+", "+this.g+", "+this.b+")"};this.toRGBA=function(){return"rgba("+this.r+", "+this.g+", "+this.b+", "+this.a+")"};this.toHex=function(){var a=this.r.toString(16),b=this.g.toString(16),k=this.b.toString(16);a.length==1&&(a="0"+a);b.length==1&&(b="0"+b);k.length==1&&(k="0"+k);return"#"+a+b+k}};Kothic.textOnPath=function(){function a(a,k){if(!n[k])n[k]=a.measureText(k).width;return n[k]}function j(a,k){return[a[1]+0.5*Math.cos(a[0])*k,a[2]+0.5*Math.sin(a[0])*k]}function c(b,k,h,c){var c=c||0,i=a(b,k),k=a(b,k.charAt(0))*1.5,f=h[0],b=Math.abs(Math.cos(f)*i)+Math.abs(Math.sin(f)*k),k=Math.abs(Math.sin(f)*i)+Math.abs(Math.cos(f)*k);return[j(h,i+2*c),b,k,0]}function e(b,k,h,e){var i,f=0;for(i=0;i<=h.length;i++){if(b.checkPointWH.apply(b,c(k,h.charAt(i),e,f)))return!0;f+=a(k,h.charAt(i))}return!1}
function o(b,c,h){var e=c[4],i=j(c,a(b,e));b.save();b.translate(Math.floor(i[0]),Math.floor(i[1]));b.rotate(c[0]);b[h?"strokeText":"fillText"](e,0,0);b.restore()}function l(a,c){var h=a.length,e,i,f,j,l,d=0;l=0;for(j=1;j<h;j++){l=a[j];f=a[j-1];e=l[0]-f[0];i=l[1]-f[1];l=Math.sqrt(e*e+i*i);if(d+l>=c)return j=c-d,h=f[0]+e*j/l,f=f[1]+i*j/l,e=Math.atan2(i,e),[e,h,f,l-j];d+=l}}var n;return function(b,k,h,j,i){n={};var f=b.measureText(h).width,u=h.length,z,d=k.length,x,A,g,q=0;for(g=1;g<d;g++)x=k[g],A=k[g-
1],z=A[0]-x[0],x=A[1]-x[1],q+=Math.sqrt(z*z+x*x);z=q;if(!(z<f)){for(var s,m=0,B,t=!1,C,F=Math.PI/6;m<2;){x=m?a(b,h.charAt(0)):(z-f)/2;B=0;A=null;s=[];for(d=0;d<u;d++){g=l(k,x);if(x>=z||!g){m++;s=[];t&&(k.reverse(),t=!1);break}A||(A=g[0]);q=h.charAt(d);C=a(b,q);if(e(i,b,q,g)||Math.abs(A-g[0])>F)x+=C,d=-1,s=[],B=0;else{for(;C<g[3]&&d<u;)if(d++,q+=h.charAt(d),C=a(b,q),e(i,b,q,g)||Math.abs(A-g[0])>F){d=0;x+=C;s=[];B=0;q=h.charAt(d);C=a(b,q);g=l(k,x);break}if(g){if(g[0]>Math.PI/2||g[0]<-Math.PI/2)B+=q.length;
A=g[0];g.push(q);s.push(g);x+=C}}}B>u/2&&(k.reverse(),s=[],t?(m++,k.reverse(),t=!1):t=!0);if(m>=2)return;if(s.length>0)break}k=s.length;for(d=0;j&&d<k;d++)o(b,s[d],!0);for(d=0;d<k;d++){g=s[d];o(b,g);j=i;h=b;f=g[4];u=g;g=void 0;for(g=z=0;g<=f.length;g++)j.addPointWH.apply(j,c(h,f.charAt(g),u,z)),z+=a(h,f.charAt(g))}}}}();
