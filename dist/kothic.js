/*
 Copyright (c) 2011, Darafei Praliaskouski, Vladimir Agafonkin, Maksim Gurtovenko
 Kothic JS is a full-featured JavaScript map rendering engine using HTML5 Canvas.
 See http://github.com/kothic/kothic-js for more information.
*/
var Kothic={};
Kothic.render=function(){function a(r,a){return parseFloat(r.style["z-index"]||0)-parseFloat(a.style["z-index"]||0)}function f(r,t,b,c,g){var d=b.features,b=[],i,o,w,f,n,l;i=0;for(w=d.length;i<w;i++){n=f=d[i];l=c;var s=g,k=0;if(s)k=s.kothicId=s.kothicId||++e;var h=void 0,B=void 0,k=[k,JSON.stringify(n.properties),l,n.type].join(":");if(!j[k]){if(n.type=="Polygon"||n.type=="MultiPolygon")h="way",B="area";else if(n.type=="LineString"||n.type=="MultiLineString")h="way",B="line";else if(n.type=="Point"||
n.type=="MultiPoint")B=h="node";j[k]=j[k]||{};j[k]=MapCSS.restyle(j[k],n.properties,l,h,B);s&&s(j[k],n.properties,l,h,B)}n=j[k];for(o in n)if(n.hasOwnProperty(o)){l={};s=f;h=void 0;for(h in s)s.hasOwnProperty(h)&&(l[h]=s[h]);l.kothicId=i+1;l.style=n[o];b.push(l)}}b.sort(a);c=0;for(g=b.length;c<g;c++)o=b[c],d=parseFloat(o.properties.layer)||0,i=o.style["-x-mapnik-layer"],i=="top"&&(d=1E4),i=="bottom"&&(d=-1E4),d in r||(r[d]=[],t.push(d)),r[d].push(o);t.sort()}function g(r,a){for(var b in a)a.hasOwnProperty(b)&&
(r[b]=a[b])}function h(a,b,c){var d=b["fill-opacity"]||b.opacity;"fill-color"in b&&(g(a,{fillStyle:b["fill-color"]||"#000000",globalAlpha:d||1}),c());if("fill-image"in b&&(b=MapCSS.getImage(b["fill-image"])))g(a,{fillStyle:a.createPattern(b,"repeat"),globalAlpha:d||1}),c()}function d(a,b,c,d){for(var g={},g=MapCSS.restyle(g,{},d,"canvas","canvas"),d=0;d<g.length;d++)h(a,g,function(){a.fillRect(-1,-1,b+1,c+1)})}function b(a,b,c,d,g,n){var i=b.style,w=c&&c.style;l||(l=!0,a.beginPath());Kothic.path(a,
b,!1,!0,d,g,n);if(!c||!(w["fill-color"]==i["fill-color"]&&w["fill-image"]==i["fill-image"]&&w["fill-opacity"]==i["fill-opacity"]))h(a,i,function(){a.fill()}),l=!1}function c(a,b,c){this.buffer=[];this.ctx=a;this.debugBoxes=b;this.debugChecks=c}function w(a){var b;switch(a.type){case "Point":b=a.coordinates;break;case "Polygon":b=a.reprpoint;break;case "LineString":b=Kothic.geomops.getPolyLength(a.coordinates);b=Kothic.geomops.getAngleAndCoordsAtLength(a.coordinates,b/2,0);b=[b[1],b[2]];break;case "GeometryCollection":case "MultiPoint":case "MultiPolygon":b=
a.reprpoint;break;case "MultiLineString":return}return b}function s(a,b){var a=a||"",b=b||9,c=a?a+", ":"",a=a.toLowerCase(),d=[];(a.indexOf("italic")!=-1||a.indexOf("oblique")!=-1)&&d.push("italic");a.indexOf("bold")!=-1&&(d.push("bold"),c+=a.replace("bold","")+", ");d.push(b+"px");c+=a.indexOf("serif")!=-1?"Georgia, serif":'"Helvetica Neue", Arial, Helvetica, sans-serif';d.push(c);return d.join(" ")}function n(a,b,c,d,n,l,i,f){var k=b.style,j=w(b);if(j){var j=[d*j[0],n*(l-j[1])],h;if(f){h=MapCSS.getImage(k["icon-image"]);
if(!h)return;if(k["allow-overlap"]!="true"&&c.checkPointWH(j,h.width,h.height,b.kothicId))return}if(i){g(a,{lineWidth:k["text-halo-radius"]*2,font:s(k["font-family"],k["font-size"])});var i=k.text+"",e=a.measureText(i).width,G=e/i.length*2.5,z=k["text-offset"]||0,E="text-halo-radius"in k;g(a,{fillStyle:k["text-color"]||"#000000",strokeStyle:k["text-halo-color"]||"#ffffff",globalAlpha:k["text-opacity"]||k.opacity||1,textAlign:"center",textBaseline:"middle"});if(b.type=="Polygon"||b.type=="Point"){if(k["text-allow-overlap"]!=
"true"&&c.checkPointWH([j[0],j[1]+z],e,G,b.kothicId))return;E&&a.strokeText(i,j[0],j[1]+z);a.fillText(i,j[0],j[1]+z);d=k["-x-mapnik-min-distance"]||20;c.addPointWH([j[0],j[1]+z],e,G,d,b.kothicId)}else if(b.type=="LineString"){for(var e=b.coordinates,G=[],z=0,B=e.length;z<B;z++)G.push([d*e[z][0],n*(l-e[z][1])]);Kothic.textOnPath(a,G,i,E,c)}}f&&(a.drawImage(h,Math.floor(j[0]-h.width/2),Math.floor(j[1]-h.height/2)),d=parseFloat(k["-x-mapnik-min-distance"])||0,c.addPointWH(j,h.width,h.height,d,b.kothicId))}}
var j={},l=!1,e=0,k={strokeStyle:"rgba(0,0,0,0.5)",fillStyle:"rgba(0,0,0,0.5)",lineWidth:1,lineCap:"round",lineJoin:"round",textAlign:"center",textBaseline:"middle"};c.prototype={addBox:function(a){this.buffer.push(a)},addPointWH:function(a,b,c,d,g){a=this.getBoxFromPoint(a,b,c,d,g);this.buffer.push(a);if(this.debugBoxes)this.ctx.save(),this.ctx.strokeStyle="red",this.ctx.lineWidth="1",this.ctx.strokeRect(a[0],a[1],a[2]-a[0],a[3]-a[1]),this.ctx.restore()},checkBox:function(a){for(var b=0,c=this.buffer.length,
d;b<c;b++)if(d=this.buffer[b],!(a[4]&&a[4]==d[4])&&d[0]<=a[2]&&d[1]<=a[3]&&d[2]>=a[0]&&d[3]>=a[1]){if(this.debugChecks)this.ctx.save(),this.ctx.strokeStyle="darkblue",this.ctx.lineWidth="1",this.ctx.strokeRect(a[0],a[1],a[2]-a[0],a[3]-a[1]),this.ctx.restore();return!0}return!1},checkPointWH:function(a,b,c,d){return this.checkBox(this.getBoxFromPoint(a,b,c,0,d))},getBoxFromPoint:function(a,b,c,d,g){return[a[0]-b/2-d,a[1]-c/2-d,a[0]+b/2+d,a[1]+c/2+d,g]}};return function(a,j,h,e,y,v){var a=typeof a==
"string"?document.getElementById(a):a,i=a.getContext("2d"),o=a.width,q=a.height,D=j.granularity,K=o/D,L=q/D,G={},z=[],E=new c,B,Q,R=+new Date,N,O,P;if(v)B=document.createElement("canvas"),B.width=o,B.height=q,Q=i,i=B.getContext("2d");window.CanvasProxy&&(i=new CanvasProxy(i));f(G,z,j,h,e);N=+new Date;g(i,k);var S=z.length,J,p,u,H,A,M;M=function(){E.addBox([0,0,o,0]);E.addBox([0,q,o,q]);E.addBox([o,0,o,q]);E.addBox([0,0,0,q]);var a=i.strokeText&&i.fillText&&i.measureText;for(J=S-1;J>=0;J--){u=G[z[J]];
H=u.length;for(p=H-1;p>=0;p--)A=u[p].style,"icon-image"in A&&!A.text&&n(i,u[p],E,K,L,D,!1,!0);for(p=H-1;a&&p>=0;p--)A=u[p].style,A.text&&!("icon-image"in A)&&n(i,u[p],E,K,L,D,!0,!1);for(p=H-1;p>=0;p--)A=u[p].style,"icon-image"in A&&A.text&&n(i,u[p],E,K,L,D,a,!0);for(p=H-1;a&&p>=0;p--)if(A=u[p].style,A["shield-text"])a:{var b=i,c=u[p],d=E,j=K,k=L,h=D,m=c.style,l=w(c);if(l){var f=[j*l[0],k*(h-l[1])],e=void 0,r=0,t=!1;if(m["shield-image"]&&(e=MapCSS.getImage(m["icon-image"]),!e))break a;g(b,{font:s(m["shield-font-family"]||
m["font-family"],m["shield-font-size"]||m["font-size"]),fillStyle:m["shield-text-color"]||"#000000",globalAlpha:m["shield-text-opacity"]||m.opacity||1,textAlign:"center",textBaseline:"middle"});var x=m["shield-text"]+"",l=b.measureText(x).width,I=l+2,F=l/x.length*1.8;c.type="LineString";r=Kothic.geomops.getPolyLength(c.coordinates);if(!(Math.max(F/k,I/j)>r)){for(var C=0,M=1;C<r/2;C+=Math.max(r/30,F/j),M*=-1){l=Kothic.geomops.getAngleAndCoordsAtLength(c.coordinates,r/2+M*C,0);if(!l)break;l=[l[1],l[2]];
f=[j*l[0],k*(h-l[1])];if((!e||!(m["allow-overlap"]!="true"&&d.checkPointWH(f,e.width,e.height,c.kothicId)))&&!(m["allow-overlap"]!="true"&&d.checkPointWH(f,I,F,c.kothicId))){t=!0;break}}t&&(m["shield-casing-width"]&&(g(b,{fillStyle:m["shield-casing-color"]||"#000000",globalAlpha:m["shield-casing-opacity"]||m.opacity||1}),b.fillRect(f[0]-I/2-(m["shield-casing-width"]||0)-(m["shield-frame-width"]||0),f[1]-F/2-(m["shield-casing-width"]||0)-(m["shield-frame-width"]||0),I+2*(m["shield-casing-width"]||
0)+2*(m["shield-frame-width"]||0),F+2*(m["shield-casing-width"]||0)+2*(m["shield-frame-width"]||0))),m["shield-frame-width"]&&(g(b,{fillStyle:m["shield-frame-color"]||"#000000",globalAlpha:m["shield-frame-opacity"]||m.opacity||1}),b.fillRect(f[0]-I/2-(m["shield-frame-width"]||0),f[1]-F/2-(m["shield-frame-width"]||0),I+2*(m["shield-frame-width"]||0),F+2*(m["shield-frame-width"]||0))),m["shield-color"]&&(g(b,{fillStyle:m["shield-color"]||"#000000",globalAlpha:m["shield-opacity"]||m.opacity||1}),b.fillRect(f[0]-
I/2,f[1]-F/2,I,F)),e&&b.drawImage(e,Math.floor(f[0]-e.width/2),Math.floor(f[1]-e.height/2)),g(b,{fillStyle:m["shield-text-color"]||"#000000",globalAlpha:m["shield-text-opacity"]||m.opacity||1}),b.fillText(x,f[0],Math.ceil(f[1])),e&&d.addPointWH(f,e.width,e.height,0,c.kothicId),d.addPointWH(f,F,I,(parseFloat(m["shield-casing-width"])||0)+(parseFloat(m["shield-frame-width"])||0)+(parseFloat(m["-x-mapnik-min-distance"])||30),c.kothicId))}}}}P=+new Date;v&&Q.drawImage(B,0,0);y({layersStyled:N-R,mapRendered:O-
N,iconsAndTextRendered:P-O,total:P-R})};setTimeout(function(){d(i,o,q,h);for(J=0;J<S;J++){u=G[z[J]];H=u.length;for(p=0;p<H;p++)A=u[p].style,("fill-color"in A||"fill-image"in A)&&b(i,u[p],u[p+1],K,L,D);i.lineCap="butt";for(p=0;p<H;p++)if("casing-width"in u[p].style){var a=i,c=u[p],f=u[p+1],j=K,k=L,n=D,e=c.style,m=f&&f.style,w=e["casing-dashes"]||e.dashes||!1;l||(l=!0,a.beginPath());Kothic.path(a,c,w,!1,j,k,n);if(!f||!(m.width==e.width&&m["casing-width"]==e["casing-width"]&&m["casing-color"]==e["casing-color"]&&
(m["casing-dashes"]||m.dashes||!1)==(e["casing-dashes"]||e.dashes||!1)&&(m["casing-linecap"]||m.linecap||"butt")==(e["casing-linecap"]||e.linecap||"butt")&&(m["casing-linejoin"]||m.linejoin||"round")==(e["casing-linejoin"]||e.linejoin||"round")&&(m["casing-opacity"]||m.opacity)==(e.opacity||e["casing-opacity"])))g(a,{lineWidth:2*e["casing-width"]+("width"in e?e.width:0),strokeStyle:e["casing-color"]||"#000000",lineCap:e["casing-linecap"]||e.linecap||"butt",lineJoin:e["casing-linejoin"]||e.linejoin||
"round",globalAlpha:e["casing-opacity"]||1}),l=!1,a.stroke()}i.lineCap="round";for(p=0;p<H;p++)if(u[p].style.width&&(a=i,c=u[p],f=u[p+1],j=K,k=L,n=D,e=c.style,m=f&&f.style,w=e.dashes,l||(l=!0,a.beginPath()),Kothic.path(a,c,w,!1,j,k,n),!f||!((m.width||1)==(e.width||1)&&(m.color||"#000000")==(e.color||"#000000")&&m.linecap==e.linecap&&m.linejoin==e.linejoin&&m.image==e.image&&m.opacity==e.opacity))){if("color"in e||not("image"in e))g(a,{lineWidth:e.width||1,strokeStyle:e.color||"#000000",lineCap:e.linecap||
"round",lineJoin:e.linejoin||"round",globalAlpha:e.opacity||1}),a.stroke();if("image"in e&&(image=MapCSS.getImage(e.image)))g(a,{strokeStyle:a.createPattern(image,"repeat")||"#000000",lineWidth:e.width||1,lineCap:e.linecap||"round",lineJoin:e.linejoin||"round",globalAlpha:e.opacity||1}),a.stroke();l=!1}O=+new Date}setTimeout(M,0)},0)}}();var MapCSS={styles:{},currentStyles:[],onError:function(){},onImagesLoad:function(){},images:{},e_min:function(){return Math.min.apply(null,arguments)},e_max:function(){return Math.max.apply(null,arguments)},e_any:function(){for(var a=0;a<arguments.length;a++)if(typeof arguments[a]!="undefined"&&arguments[a]!=="")return arguments[a];return""},e_num:function(a){return isNaN(parseFloat(a))?"":parseFloat(a)},e_str:function(a){return a},e_int:function(a){return parseInt(a,10)},e_tag:function(a,f){return f in
a&&a[f]!==null?a[f]:""},e_prop:function(a,f){return f in a&&a[f]!==null?a[f]:""},e_sqrt:function(a){return Math.sqrt(a)},e_boolean:function(a){return a=="0"||a=="false"||a===""?"false":"true"},e_boolean:function(a,f,g){return MapCSS.e_boolean(a)=="true"?f:g},e_metric:function(a){return/\d\s*mm$/.test(a)?1E3*parseInt(a,10):/\d\s*cm$/.test(a)?100*parseInt(a,10):/\d\s*dm$/.test(a)?10*parseInt(a,10):/\d\s*km$/.test(a)?0.0010*parseInt(a,10):/\d\s*in$/.test(a)?0.0254*parseInt(a,10):/\d\s*ft$/.test(a)?0.3048*
parseInt(a,10):parseInt(a,10)},e_zmetric:function(a){return MapCSS.metric(a)},loadStyle:function(a,f,g,h){MapCSS.styles[a]={restyle:f,images:g,external_images:h,textures:{},sprite_loaded:!g,external_images_loaded:!h.length};MapCSS.currentStyles.push(a)},_onImagesLoad:function(a){if(MapCSS.styles[a].external_images_loaded&&MapCSS.styles[a].sprite_loaded)MapCSS.onImagesLoad()},preloadSpriteImage:function(a,f){var g=MapCSS.styles[a].images;delete MapCSS.styles[a].images;var h=new Image;h.onload=function(){for(var d in g)if(g.hasOwnProperty(d))g[d].sprite=
h,MapCSS.images[d]=g[d];MapCSS.styles[a].sprite_loaded=!0;MapCSS._onImagesLoad(a)};h.onerror=function(a){MapCSS.onError(a)};h.src=f},preloadExternalImages:function(a){var f=MapCSS.styles[a].external_images;delete MapCSS.styles[a].external_images;for(var g=f.length,h=0,d=0;d<g;d++)(function(b){var c=new Image;c.onload=function(){h++;MapCSS.images[b]={sprite:c,height:c.height,width:c.width,offset:0};if(h==g)MapCSS.styles[a].external_images_loaded=!0,MapCSS._onImagesLoad(a)};c.onerror=function(){h++;
if(h==g)MapCSS.styles[a].external_images_loaded=!0,MapCSS._onImagesLoad(a)};c.src=b})(f[d])},getImage:function(a){var f=MapCSS.images[a];if(f.sprite){var g=document.createElement("canvas");g.width=f.width;g.height=f.height;g.getContext("2d").drawImage(f.sprite,0,f.offset,f.width,f.height,0,0,f.width,f.height);f=MapCSS.images[a]=g}return f},restyle:function(a,f,g,h,d){for(var b,c=0;c<MapCSS.currentStyles.length;c++)b=MapCSS.currentStyles[c],a=MapCSS.styles[b].restyle(a,f,g,h,d);return a}};Kothic.path=function(){function a(a,b){h={pattern:b,seg:0,phs:0,x:a[0],y:a[1]}}function f(a,b){var c=h,f=b[0]-c.x,g=b[1]-c.y,n=Math.sqrt(f*f+g*g),j;a.save();a.translate(c.x,c.y);a.rotate(Math.atan2(g,f));a.moveTo(0,0);f=0;do{j=c.pattern[c.seg];f+=j-c.phs;g=f<n;if(!g)c.phs=j-(f-n),f=n;a[c.seg%2?"moveTo":"lineTo"](f,0);if(g)c.phs=0,c.seg=++c.seg%c.pattern.length}while(g);c.x=b[0];c.y=b[1];a.restore()}function g(a,b){return a[0]===0||a[0]==b||a[1]===0||a[1]==b}var h;return function(d,b,c,h,s,n,j){var l=
b.type,b=b.coordinates;l=="Polygon"&&(b=[b],l="MultiPolygon");l=="LineString"&&(b=[b],l="MultiLineString");var e,k,r,t,x=b.length,C,y,v,i,o;if(l=="MultiPolygon")for(e=0;e<x;e++){r=0;for(C=b[e].length;r<C;r++){t=b[e][r];y=t.length;v=t[0];for(k=0;k<=y;k++)i=t[k]||t[0],o=[s*i[0],n*(j-i[1])],k===0||!h&&g(i,j)&&g(v,j)?(v=c,d.moveTo(o[0],o[1]),v&&a(o,v)):h||!c?d.lineTo(o[0],o[1]):f(d,o),v=i}}if(l=="MultiLineString")for(e=0;e<x;e++){t=b[e];y=t.length;for(k=0;k<y;k++){i=t[k];o=[s*i[0],n*(j-i[1])];if((k===
0||k==y-1)&&g(i,j))v=t[k?y-2:1],h=i[0]-v[0],l=i[1]-v[1],i=Math.sqrt(h*h+l*l),o=[o[0]+50*h/i,o[1]-50*l/i];k===0?(h=o,l=c,d.moveTo(h[0],h[1]),l&&a(h,l)):c?f(d,o):d.lineTo(o[0],o[1])}}}}();Kothic.textOnPath=function(){function a(a,c){return a.measureText(c).width}function f(a,c){return[a[1]+0.5*Math.cos(a[0])*c,a[2]+0.5*Math.sin(a[0])*c]}function g(b,c,d,g){var g=g||0,h=a(b,c),c=a(b,c.charAt(0))*1.5,j=d[0],b=Math.abs(Math.cos(j)*h)+Math.abs(Math.sin(j)*c),c=Math.abs(Math.sin(j)*h)+Math.abs(Math.cos(j)*c);return[f(d,h+2*g),b,c,0]}function h(b,c,d,f){var h,j=0;for(h=0;h<=d.length;h++){if(b.checkPointWH.apply(b,g(c,d.charAt(h),f,j)))return!0;j+=a(c,d.charAt(h))}return!1}function d(b,c,
d){var g=c[4],h=f(c,a(b,g));b.save();b.translate(h[0],h[1]);b.rotate(c[0]);b[d?"strokeText":"fillText"](g,0,0);b.restore()}return function(b,c,f,s,n){var j=b.measureText(f).width,l=f.length,e=Kothic.geomops.getPolyLength(c);if(!(e<j)){for(var k,r,t,x,C=0,y,v=!1,i,o,q,D=Math.PI/6;C<2;){r=C?a(b,f.charAt(0)):(e-j)/2;y=0;t=null;x=[];for(q=0;q<l;q++){k=f.charAt(q);o=a(b,k);i=Kothic.geomops.getAngleAndCoordsAtLength(c,r,o);if(r>=e||!i){C++;x=[];v&&(c.reverse(),v=!1);break}t||(t=i[0]);if(h(n,b,k,i)||Math.abs(t-
i[0])>D)r+=o,q=-1,x=[],y=0;else{for(;o<i[3]&&q<l;){q++;k+=f.charAt(q);o=a(b,k);if(h(n,b,k,i)){q=0;r+=o;x=[];y=0;k=f.charAt(q);o=a(b,k);i=Kothic.geomops.getAngleAndCoordsAtLength(c,r,o);break}if(o>=i[3]){q--;k=k.slice(0,-1);o=a(b,k);break}}if(i){if(i[0]>Math.PI/2||i[0]<-Math.PI/2)y+=k.length;t=i[0];i.push(k);x.push(i);r+=o}}}y>l/2&&(c.reverse(),x=[],v?(C++,c.reverse(),v=!1):v=!0);if(C>=2)return;if(x.length>0)break}c=x.length;for(q=0;s&&q<c;q++)d(b,x[q],!0);for(q=0;q<c;q++){i=x[q];d(b,i);s=n;f=b;j=
i[4];l=void 0;for(l=e=0;l<=j.length;l++)s.addPointWH.apply(s,g(f,j.charAt(l),i,e)),e+=a(f,j.charAt(l))}}}}();Kothic=Kothic||{};Kothic.geomops=Kothic.geomops||{};Kothic.geomops.getPolyLength=function(a){var f=a.length,g,h,d,b,c=0;for(d=1;d<f;d++)g=a[d],h=a[d-1],b=h[0]-g[0],g=h[1]-g[1],c+=Math.sqrt(b*b+g*g);return c};
Kothic.geomops.getAngleAndCoordsAtLength=function(a,f,g){var h=a.length,d,b,c,w,s,n,j,l=0;n=0;var e,k=!0;e=!1;g=g||0;for(s=1;s<h;s++){e&&(k=!1);n=a[s];j=a[s-1];d=n[0]-j[0];b=n[1]-j[1];n=Math.sqrt(d*d+b*b);!e&&l+n>=f&&(e=f-l,c=j[0]+d*e/n,w=j[1]+b*e/n,e=!0);if(e&&l+n>=f+g)return e=f+g-l,d=j[0]+d*e/n,b=j[1]+b*e/n,a=Math.atan2(b-w,d-c),k?[a,c,w,n-e]:[a,c,w,0];l+=n}};
